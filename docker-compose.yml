services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: hoonian-app
    container_name: hoonian-app
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      # Only mount storage for persistence
      - storage-data:/var/www/storage
    networks:
      - hoonian-network
    depends_on:
      - redis
    environment:
      APP_NAME: "Hoonian"
      APP_ENV: production
      APP_KEY: "${APP_KEY}"
      APP_DEBUG: "false"
      APP_URL: "${APP_URL:-http://localhost:8004}"
      DB_CONNECTION: mysql
      # Use mariadb container name as hostname
      # Or use host.docker.internal to connect to host's database
      DB_HOST: "${DB_HOST:-mariadb}"
      DB_PORT: "${DB_PORT:-3306}"
      DB_DATABASE: "${DB_DATABASE:-hoonian}"
      DB_USERNAME: "${DB_USERNAME:-hoonian_admin}"
      DB_PASSWORD: "${DB_PASSWORD}"
      REDIS_HOST: redis
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      # Google OAuth
      GOOGLE_CLIENT_ID: "${GOOGLE_CLIENT_ID}"
      GOOGLE_CLIENT_SECRET: "${GOOGLE_CLIENT_SECRET}"
      GOOGLE_REDIRECT_URI: "${GOOGLE_REDIRECT_URI}"
    # Add extra_hosts to access host's database
    extra_hosts:
      - "host.docker.internal:host-gateway"

  nginx:
    image: nginx:alpine
    container_name: hoonian-nginx
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8004}:80"
    volumes:
      - ./docker/nginx/conf.d:/etc/nginx/conf.d
      - ./public:/var/www/public:ro
      - storage-data:/var/www/storage:ro
    networks:
      - hoonian-network
    depends_on:
      - app

  redis:
    image: redis:alpine
    container_name: hoonian-redis
    restart: unless-stopped
    networks:
      - hoonian-network

networks:
  hoonian-network:
    driver: bridge

volumes:
  storage-data:
    driver: local
